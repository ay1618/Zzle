<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zzle Game Level Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1, h2, h3, h4 {
            color: #333;
        }
        
        .container {
            display: flex;
            gap: 20px;
        }
        
        .sidebar {
            width: 250px;
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .main-content {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .level-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .level-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .level-item:hover {
            background-color: #e0e0e0;
        }
        
        .level-item.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        button {
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button.danger {
            background-color: #f44336;
        }
        
        button.danger:hover {
            background-color: #d32f2f;
        }
        
        button.secondary {
            background-color: #2196F3;
        }
        
        button.secondary:hover {
            background-color: #1976D2;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        textarea {
            width: 100%;
            height: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
        }
        
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(16, 20px);
            grid-template-rows: repeat(16, 20px);
            gap: 1px;
            background-color: #ccc;
            margin-top: 15px;
        }
        
        .grid-cell {
            width: 20px;
            height: 20px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            position: relative;
            cursor: pointer;
        }
        
        .grid-cell.colored {
            position: relative;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            cursor: pointer;
            position: relative;
            top: 1px;
        }
        
        .tab-button.active {
            background-color: white;
            border-bottom: 1px solid white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Новые стили для улучшенных инструментов */
        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 40px;
            min-height: 40px;
        }
        
        .tool-btn:hover {
            background-color: #e0e0e0;
        }
        
        .tool-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #388E3C;
        }
        
        .tool-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        .tool-btn.active svg {
            fill: white;
        }
        
        .tool-label {
            display: block;
            font-size: 12px;
            margin-top: 4px;
            text-align: center;
        }
        
        .tool-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .arrow-rotation-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .arrow-rotation-controls button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .arrow-rotation-controls button:hover {
            background-color: #1976D2;
        }
        
        .arrow-rotation-controls svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        
        .arrow-preview {
            width: 40px;
            height: 40px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .arrow-preview::after {
            content: "▲";
            font-size: 20px;
            transform-origin: center;
            transition: transform 0.2s;
        }
        
        .arrow-preview[data-direction="0"]::after { transform: rotate(0deg); }
        .arrow-preview[data-direction="1"]::after { transform: rotate(90deg); }
        .arrow-preview[data-direction="2"]::after { transform: rotate(180deg); }
        .arrow-preview[data-direction="3"]::after { transform: rotate(270deg); }
        
        .direction-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .grid-cell.arrow::after {
            content: "▲";
            font-size: 16px;
            position: absolute;
            transform-origin: center;
        }
        
        .grid-cell.star::after {
            content: "⭐";
            font-size: 16px;
            position: absolute;
        }
        
        .grid-cell.arrow[data-direction="0"]::after { transform: rotate(0deg); }
        .grid-cell.arrow[data-direction="1"]::after { transform: rotate(90deg); }
        .grid-cell.arrow[data-direction="2"]::after { transform: rotate(180deg); }
        .grid-cell.arrow[data-direction="3"]::after { transform: rotate(270deg); }
        
        .color-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .color-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .color-btn.selected {
            border-color: black;
        }
        
        .orange {
            background-color: #ff9800;
        }
        
        .purple {
            background-color: #9c27b0;
        }
        
        .turquoise {
            background-color: #00bcd4;
        }
        
        .eraser {
            background-color: white;
            border: 1px solid #ccc;
            position: relative;
        }
        
        .eraser::before, 
        .eraser::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 2px;
            background-color: #f44336;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        
        .eraser::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }
        
        .tool-panel {
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tool-panel h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Zzle Game Level Editor</h1>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <div class="container">
        <div class="sidebar">
            <h2>Levels</h2>
            <ul id="levelList" class="level-list"></ul>
            
            <div class="button-row">
                <button id="newLevelBtn">New Level</button>
                <button id="deleteLevelBtn" class="danger">Delete</button>
            </div>
            
            <div class="button-row">
                <button id="saveAllBtn" class="secondary">Save All</button>
                <button id="exportBtn" class="secondary">Export</button>
                <button id="importBtn" class="secondary">Import</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="tab-container">
                <div class="tab-buttons">
                    <div class="tab-button active" data-tab="visualEditor">Visual Editor</div>
                    <div class="tab-button" data-tab="jsonEditor">JSON Editor</div>
                </div>
                
                <div class="tab-content active" id="visualEditor">
                    <div class="form-group">
                        <label for="levelName">Level Name</label>
                        <input type="text" id="levelName" placeholder="Enter level name">
                    </div>
                    
                    <div class="form-group">
                        <label for="levelKey">Level Key (unique identifier)</label>
                        <input type="text" id="levelKey" placeholder="e.g., level1, myLevel, etc.">
                    </div>
                    
                    <h3>Stacks Configuration</h3>
                    <div id="stacksConfig">
                        <div class="form-group">
                            <label>Stack 0 Size</label>
                            <input type="number" class="stack-size" data-stack="0" min="1" max="10" value="4">
                        </div>
                        <div class="form-group">
                            <label>Stack 1 Size</label>
                            <input type="number" class="stack-size" data-stack="1" min="0" max="10" value="3">
                        </div>
                        <div class="form-group">
                            <label>Stack 2 Size</label>
                            <input type="number" class="stack-size" data-stack="2" min="0" max="10" value="0">
                        </div>
                    </div>
                    
                    <h3>Grid Editor</h3>
                    <div class="tool-panel">
                        <div class="tool-buttons">
                            <div id="colorTool" class="tool-btn active">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,11A1,1 0 0,0 11,12A1,1 0 0,0 12,13A1,1 0 0,0 13,12A1,1 0 0,0 12,11Z"></path>
                                </svg>
                                <span class="tool-label">Color</span>
                            </div>
                            
                            <div id="starTool" class="tool-btn">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"></path>
                                </svg>
                                <span class="tool-label">Star</span>
                            </div>
                            
                            <div id="arrowTool" class="tool-btn">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z"></path>
                                </svg>
                                <span class="tool-label">Arrow</span>
                            </div>
                            
                            <div id="eraseTool" class="tool-btn">
                                <svg viewBox="0 0 24 24">
                                    <path d="M16.24,3.56L21.19,8.5C21.97,9.29 21.97,10.55 21.19,11.34L12,20.53C10.44,22.09 7.91,22.09 6.34,20.53L2.81,17C2.03,16.21 2.03,14.95 2.81,14.16L13.41,3.56C14.2,2.78 15.46,2.78 16.24,3.56M4.22,15.58L7.76,19.11C8.54,19.9 9.8,19.9 10.59,19.11L14.12,15.58L9.17,10.63L4.22,15.58Z"></path>
                                </svg>
                                <span class="tool-label">Erase</span>
                            </div>
                        </div>
                        
                        <div id="arrowControls" style="display: none;">
                            <h4>Arrow Settings</h4>
                            <div class="arrow-rotation-controls">
                                <button id="rotateLeft" title="Rotate Left">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12,5V1L7,6L12,11V7A6,6 0 0,1 18,13A6,6 0 0,1 12,19A6,6 0 0,1 6,13H4A8,8 0 0,0 12,21A8,8 0 0,0 20,13A8,8 0 0,0 12,5Z"></path>
                                    </svg>
                                </button>
                                
                                <div class="arrow-direction-display">
                                    <div id="arrowPreview" class="arrow-preview" data-direction="0"></div>
                                    <div class="direction-label">
                                        Direction: <span id="directionName">Up</span>
                                    </div>
                                </div>
                                
                                <button id="rotateRight" title="Rotate Right">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12,5V1L7,6L12,11V7A6,6 0 0,1 18,13A6,6 0 0,1 12,19A6,6 0 0,1 6,13H4A8,8 0 0,0 12,21A8,8 0 0,0 20,13A8,8 0 0,0 12,5Z" transform="scale(-1, 1) translate(-24, 0)"></path>
                                    </svg>
                                </button>
                                
                                <input type="hidden" id="arrowDirection" value="0">
                            </div>
                        </div>
                        
                        <div id="colorControls">
                            <h4>Color Selection</h4>
                            <div class="color-selector">
                                <div class="color-btn orange selected" data-color="orange"></div>
                                <div class="color-btn purple" data-color="purple"></div>
                                <div class="color-btn turquoise" data-color="turquoise"></div>
                                <div class="color-btn eraser" data-color="eraser"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-container" id="editorGrid"></div>
                    
                    <div class="button-row" style="margin-top: 20px;">
                        <button id="saveBtn">Save Level</button>
                        <button id="previewBtn" class="secondary">Preview</button>
                        <button id="clearGridBtn" class="danger">Clear Grid</button>
                    </div>
                </div>
                
                <div class="tab-content" id="jsonEditor">
                    <div class="form-group">
                        <label for="jsonData">Level JSON</label>
                        <textarea id="jsonData" placeholder="Enter level JSON"></textarea>
                    </div>
                    
                    <div class="button-row">
                        <button id="updateFromJsonBtn">Update Level</button>
                        <button id="formatJsonBtn" class="secondary">Format JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <input type="file" id="importFile" style="display: none;" accept=".json">
    
    <script>
        // Global variables
        let allLevels = {};
        let currentLevelKey = null;
        let currentTool = 'color';
        let currentColor = 'orange';
        let isDirty = false; // Flag to track unsaved changes
        
        // Constants
        const STORAGE_KEY = 'zzle_game_levels';
        
        // DOM Elements
        const levelListEl = document.getElementById('levelList');
        const levelNameEl = document.getElementById('levelName');
        const levelKeyEl = document.getElementById('levelKey');
        const editorGridEl = document.getElementById('editorGrid');
        const jsonDataEl = document.getElementById('jsonData');
        const messageEl = document.getElementById('message');
        
        // Initialize the editor
        function initEditor() {
            createGrid();
            setupEventListeners();
            loadLevelsFromStorage();
            updateLevelList();
            
            // Select first level if exists
            const firstLevel = Object.keys(allLevels)[0];
            if (firstLevel) {
                selectLevel(firstLevel);
            } else {
                // Create a default level if none exists
                createDefaultLevel();
            }
        }
        
        // Create default level
        function createDefaultLevel() {
            const newKey = 'level1';
            const newName = 'Simple Path';
            
            allLevels[newKey] = {
                name: newName,
                stacks: [
                    { size: 4 },
                    { size: 3 }
                ],
                arrow: {
                    position: { x: 5, y: 5 },
                    direction: 0
                },
                stars: [
                    { x: 8, y: 7 }
                ],
                coloredCells: [
                    { x: 5, y: 5, color: "orange" },
                    { x: 6, y: 5, color: "orange" },
                    { x: 7, y: 5, color: "orange" },
                    { x: 8, y: 5, color: "purple" },
                    { x: 8, y: 6, color: "purple" },
                    { x: 8, y: 7, color: "turquoise" },
                    { x: 7, y: 7, color: "turquoise" },
                    { x: 6, y: 7, color: "turquoise" }
                ]
            };
            
            updateLevelList();
            selectLevel(newKey);
            saveAllLevels();
        }
        
        // Create the grid for visual editing
        function createGrid() {
            editorGridEl.innerHTML = '';
            
            for (let y = 0; y < 16; y++) {
                for (let x = 0; x < 16; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.addEventListener('click', () => handleGridCellClick(x, y));
                    editorGridEl.appendChild(cell);
                }
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Switch tabs
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    button.classList.add('active');
                    const tabId = button.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                    
                    // If switching to JSON editor, update the JSON display
                    if (tabId === 'jsonEditor' && currentLevelKey) {
                        updateJsonDisplay();
                    }
                    
                    // If switching to visual editor, update the grid
                    if (tabId === 'visualEditor' && currentLevelKey) {
                        updateGridFromCurrentLevel();
                    }
                });
            });
            
            // Tool buttons
            document.getElementById('colorTool').addEventListener('click', () => {
                setCurrentTool('color');
                document.getElementById('colorControls').style.display = 'block';
                document.getElementById('arrowControls').style.display = 'none';
            });
            
            document.getElementById('starTool').addEventListener('click', () => {
                setCurrentTool('star');
                document.getElementById('colorControls').style.display = 'none';
                document.getElementById('arrowControls').style.display = 'none';
            });
            
            document.getElementById('arrowTool').addEventListener('click', () => {
                setCurrentTool('arrow');
                document.getElementById('colorControls').style.display = 'none';
                document.getElementById('arrowControls').style.display = 'block';
            });
            
            document.getElementById('eraseTool').addEventListener('click', () => {
                setCurrentTool('erase');
                document.getElementById('colorControls').style.display = 'none';
                document.getElementById('arrowControls').style.display = 'none';
            });
            
            // Color buttons
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    currentColor = btn.dataset.color;
                });
            });
            
            // Arrow rotation controls
            document.getElementById('rotateLeft').addEventListener('click', () => {
                let currentDir = parseInt(document.getElementById('arrowDirection').value);
                currentDir = (currentDir + 3) % 4; // Поворот против часовой стрелки
                updateArrowDirection(currentDir);
            });
            
            document.getElementById('rotateRight').addEventListener('click', () => {
                let currentDir = parseInt(document.getElementById('arrowDirection').value);
                currentDir = (currentDir + 1) % 4; // Поворот по часовой стрелке
                updateArrowDirection(currentDir);
            });
            
            // Level management buttons
            document.getElementById('newLevelBtn').addEventListener('click', createNewLevel);
            document.getElementById('deleteLevelBtn').addEventListener('click', deleteCurrentLevel);
            document.getElementById('saveBtn').addEventListener('click', saveCurrentLevel);
            document.getElementById('saveAllBtn').addEventListener('click', saveAllLevels);
            document.getElementById('clearGridBtn').addEventListener('click', clearGrid);
            document.getElementById('previewBtn').addEventListener('click', previewLevel);
            
            // JSON editor buttons
            document.getElementById('updateFromJsonBtn').addEventListener('click', updateLevelFromJson);
            document.getElementById('formatJsonBtn').addEventListener('click', formatJson);
            
            // Import/Export buttons
            document.getElementById('exportBtn').addEventListener('click', exportLevels);
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            
            document.getElementById('importFile').addEventListener('change', importLevels);
        }
        
        // Update arrow direction in UI
        function updateArrowDirection(direction) {
            const arrowDirection = document.getElementById('arrowDirection');
            const arrowPreview = document.getElementById('arrowPreview');
            const directionName = document.getElementById('directionName');
            const directionNames = ['Up', 'Right', 'Down', 'Left'];
            
            arrowDirection.value = direction;
            arrowPreview.dataset.direction = direction;
            directionName.textContent = directionNames[direction];
        }
        
        // Load levels from localStorage
        function loadLevelsFromStorage() {
            const levelsJson = localStorage.getItem(STORAGE_KEY);
            if (levelsJson) {
                try {
                    allLevels = JSON.parse(levelsJson);
                    console.log("Levels loaded successfully:", Object.keys(allLevels).length, "levels found");
                } catch (error) {
                    console.error("Error parsing levels from localStorage:", error);
                    allLevels = {};
                }
            } else {
                console.log("No levels found in localStorage");
                allLevels = {};
            }
        }
        
        // Save levels to localStorage
        function saveLevelsToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allLevels));
                console.log("Levels saved to localStorage");
                return true;
            } catch (error) {
                console.error("Error saving levels to localStorage:", error);
                return false;
            }
        }
        
        // Export levels to JSON file
        function exportLevels() {
            const levelsJson = JSON.stringify(allLevels, null, 2);
            const blob = new Blob([levelsJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'zzle_levels.json';
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
            
            showMessage("Levels exported to file", "success");
        }
        
        // Update the level list in sidebar
        function updateLevelList() {
            levelListEl.innerHTML = '';
            
            Object.keys(allLevels).forEach(levelKey => {
                const levelItem = document.createElement('li');
                levelItem.className = 'level-item';
                if (levelKey === currentLevelKey) {
                    levelItem.classList.add('active');
                }
                
                levelItem.textContent = allLevels[levelKey].name || levelKey;
                levelItem.dataset.key = levelKey;
                levelItem.addEventListener('click', () => {
                    if (isDirty) {
                        if (confirm("You have unsaved changes. Do you want to discard them?")) {
                            selectLevel(levelKey);
                        }
                    } else {
                        selectLevel(levelKey);
                    }
                });
                
                levelListEl.appendChild(levelItem);
            });
        }
        
        // Select a level for editing
        function selectLevel(levelKey) {
            if (!allLevels[levelKey]) {
                console.error(`Level ${levelKey} not found!`);
                return;
            }
            
            currentLevelKey = levelKey;
            updateLevelList(); // Update selected item in list
            
            // Update form fields
            levelNameEl.value = allLevels[levelKey].name || '';
            levelKeyEl.value = levelKey;
            
            // Update stacks
            const stacks = allLevels[levelKey].stacks || [];
            document.querySelectorAll('.stack-size').forEach((input, index) => {
                input.value = index < stacks.length ? stacks[index].size : 0;
            });
            
            // Update grid
            updateGridFromCurrentLevel();
            
            // Update JSON display
            updateJsonDisplay();
            
            isDirty = false;
        }
        
        // Update grid display from current level data
        function updateGridFromCurrentLevel() {
            // Reset grid
            clearGrid(false);
            
            if (!currentLevelKey || !allLevels[currentLevelKey]) return;
            
            const level = allLevels[currentLevelKey];
            
            // Add colored cells
            if (level.coloredCells) {
                level.coloredCells.forEach(cell => {
                    const gridCell = document.querySelector(`.grid-cell[data-x="${cell.x}"][data-y="${cell.y}"]`);
                    if (gridCell) {
                        gridCell.classList.add('colored');
                        gridCell.style.backgroundColor = cell.color;
                    }
                });
            }
            
            // Add stars
            if (level.stars) {
                level.stars.forEach(star => {
                    const gridCell = document.querySelector(`.grid-cell[data-x="${star.x}"][data-y="${star.y}"]`);
                    if (gridCell) {
                        gridCell.classList.add('star');
                    }
                });
            }
            
            // Add arrow
            if (level.arrow) {
                const gridCell = document.querySelector(`.grid-cell[data-x="${level.arrow.position.x}"][data-y="${level.arrow.position.y}"]`);
                if (gridCell) {
                    gridCell.classList.add('arrow');
                    gridCell.dataset.direction = level.arrow.direction;
                }
                
                // Update arrow direction controls
                updateArrowDirection(level.arrow.direction);
            }
        }
        
        // Update JSON display
        function updateJsonDisplay() {
            if (!currentLevelKey || !allLevels[currentLevelKey]) {
                jsonDataEl.value = '';
                return;
            }
            
            jsonDataEl.value = JSON.stringify(allLevels[currentLevelKey], null, 2);
        }
        
        // Set current tool
        function setCurrentTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tool}Tool`).classList.add('active');
        }
        
        // Handle grid cell click
        function handleGridCellClick(x, y) {
            if (!currentLevelKey) {
                showMessage("Please select or create a level first.", "warning");
                return;
            }
            
            const gridCell = document.querySelector(`.grid-cell[data-x="${x}"][data-y="${y}"]`);
            
            switch (currentTool) {
                case 'color':
                    if (currentColor === 'eraser') {
                        // Remove color
                        gridCell.style.backgroundColor = '';
                        gridCell.classList.remove('colored');
                    } else {
                        // Add color
                        gridCell.style.backgroundColor = currentColor;
                        gridCell.classList.add('colored');
                    }
                    break;
                    
                case 'star':
                    // Toggle star
                    if (gridCell.classList.contains('star')) {
                        gridCell.classList.remove('star');
                    } else {
                        gridCell.classList.add('star');
                    }
                    break;
                    
                case 'arrow':
                    // First remove any existing arrow
                    document.querySelectorAll('.grid-cell.arrow').forEach(cell => {
                        cell.classList.remove('arrow');
                        delete cell.dataset.direction;
                    });
                    
                    // Add new arrow
                    gridCell.classList.add('arrow');
                    gridCell.dataset.direction = document.getElementById('arrowDirection').value;
                    break;
                    
                case 'erase':
                    // Remove everything from cell
                    gridCell.style.backgroundColor = '';
                    gridCell.classList.remove('colored', 'star', 'arrow');
                    delete gridCell.dataset.direction;
                    break;
            }
            
            isDirty = true;
        }
        
        // Create a new level
        function createNewLevel() {
            if (isDirty && !confirm("You have unsaved changes. Do you want to discard them?")) {
                return;
            }
            
            const newKey = `level${Object.keys(allLevels).length + 1}`;
            const newName = `New Level ${Object.keys(allLevels).length + 1}`;
            
            allLevels[newKey] = {
                name: newName,
                stacks: [
                    { size: 4 },
                    { size: 3 }
                ],
                arrow: {
                    position: { x: 5, y: 5 },
                    direction: 0
                },
                stars: [],
                coloredCells: []
            };
            
            updateLevelList();
            selectLevel(newKey);
            showMessage(`Created new level: ${newName}`, "success");
            isDirty = true;
        }
        
        // Delete current level
        function deleteCurrentLevel() {
            if (!currentLevelKey) {
                showMessage("No level selected to delete.", "warning");
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the level "${allLevels[currentLevelKey].name}"?`)) {
                return;
            }
            
            delete allLevels[currentLevelKey];
            
            showMessage(`Deleted level: ${currentLevelKey}`, "success");
            updateLevelList();
            
            // Select the first level if available
            const firstLevel = Object.keys(allLevels)[0];
            if (firstLevel) {
                selectLevel(firstLevel);
            } else {
                currentLevelKey = null;
                clearGrid();
                levelNameEl.value = '';
                levelKeyEl.value = '';
                jsonDataEl.value = '';
            }
            
            isDirty = true;
            saveAllLevels(); // Save changes after deletion
        }
        
        // Save current level
        function saveCurrentLevel() {
            if (!currentLevelKey) {
                showMessage("No level selected to save.", "warning");
                return;
            }
            
            const name = levelNameEl.value.trim();
            if (!name) {
                showMessage("Please enter a level name.", "error");
                return;
            }
            
            const newKey = levelKeyEl.value.trim();
            if (!newKey) {
                showMessage("Please enter a level key.", "error");
                return;
            }
            
            // Collect stacks data
            const stacks = [];
            document.querySelectorAll('.stack-size').forEach((input) => {
                const size = parseInt(input.value) || 0;
                if (size > 0) {
                    stacks.push({ size });
                }
            });
            
            // Collect colored cells
            const coloredCells = [];
            document.querySelectorAll('.grid-cell.colored').forEach(cell => {
                const x = parseInt(cell.dataset.x);
                const y = parseInt(cell.dataset.y);
                const color = cell.style.backgroundColor;
                
                coloredCells.push({
                    x, y, 
                    color: color === 'rgb(255, 152, 0)' ? 'orange' : 
                           color === 'rgb(156, 39, 176)' ? 'purple' : 
                           'turquoise'
                });
            });
            
            // Collect stars
            const stars = [];
            document.querySelectorAll('.grid-cell.star').forEach(cell => {
                const x = parseInt(cell.dataset.x);
                const y = parseInt(cell.dataset.y);
                stars.push({ x, y });
            });
            
            // Get arrow data
            let arrow = null;
            const arrowCell = document.querySelector('.grid-cell.arrow');
            if (arrowCell) {
                arrow = {
                    position: {
                        x: parseInt(arrowCell.dataset.x),
                        y: parseInt(arrowCell.dataset.y)
                    },
                    direction: parseInt(arrowCell.dataset.direction || 0)
                };
            } else {
                showMessage("Please place an arrow on the grid.", "error");
                return;
            }
            
            // Create level data
            const levelData = {
                name,
                stacks,
                arrow,
                stars,
                coloredCells
            };
            
            // If level key changed, remove old one
            if (newKey !== currentLevelKey) {
                delete allLevels[currentLevelKey];
            }
            
            // Save level data
            allLevels[newKey] = levelData;
            currentLevelKey = newKey;
            
            updateLevelList();
            updateJsonDisplay();
            
            // Save to localStorage
            saveLevelsToStorage();
            
            showMessage(`Saved level: ${name}`, "success");
            isDirty = false;
        }
        
        // Save all levels to storage
        function saveAllLevels() {
            if (saveLevelsToStorage()) {
                showMessage("All levels saved successfully!", "success");
                isDirty = false;
            } else {
                showMessage("Failed to save levels to storage", "error");
            }
        }
        
        // Clear the grid
        function clearGrid(markDirty = true) {
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.style.backgroundColor = '';
                cell.classList.remove('colored', 'star', 'arrow');
                delete cell.dataset.direction;
            });
            
            if (markDirty) {
                isDirty = true;
            }
        }
        
        // Preview the level
        function previewLevel() {
            if (!currentLevelKey) {
                showMessage("No level selected to preview.", "warning");
                return;
            }
            
            // Save current level first
            saveCurrentLevel();
            
            // Open game in new window/tab with level parameter
            window.open(`index.html?level=${currentLevelKey}`, '_blank');
        }
        
        // Update level from JSON editor
        function updateLevelFromJson() {
            if (!currentLevelKey) {
                showMessage("No level selected to update.", "warning");
                return;
            }
            
            try {
                const jsonData = JSON.parse(jsonDataEl.value);
                
                // Validate required fields
                if (!jsonData.name) throw new Error("Level name is required");
                if (!jsonData.arrow) throw new Error("Arrow position is required");
                if (!jsonData.stars || !Array.isArray(jsonData.stars)) throw new Error("Stars array is required");
                if (!jsonData.coloredCells || !Array.isArray(jsonData.coloredCells)) throw new Error("ColoredCells array is required");
                if (!jsonData.stacks || !Array.isArray(jsonData.stacks)) throw new Error("Stacks array is required");
                
                // Update level data
                allLevels[currentLevelKey] = jsonData;
                
                // Update UI
                updateLevelList();
                selectLevel(currentLevelKey);
                
                showMessage("Level updated from JSON", "success");
                isDirty = true;
                
                // Save changes
                saveAllLevels();
            } catch (error) {
                showMessage(`JSON Error: ${error.message}`, "error");
            }
        }
        
        // Format JSON in editor
        function formatJson() {
            try {
                const jsonData = JSON.parse(jsonDataEl.value);
                jsonDataEl.value = JSON.stringify(jsonData, null, 2);
            } catch (error) {
                showMessage(`JSON Error: ${error.message}`, "error");
            }
        }
        
        // Import levels from file
        function importLevels(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Validate format
                    if (typeof jsonData !== 'object') {
                        throw new Error("Invalid JSON format");
                    }
                    
                    // Ask for confirmation
                    const numLevels = Object.keys(jsonData).length;
                    if (confirm(`Import ${numLevels} levels? This will replace all existing levels.`)) {
                        allLevels = jsonData;
                        updateLevelList();
                        
                        // Select the first level
                        const firstLevel = Object.keys(allLevels)[0];
                        if (firstLevel) {
                            selectLevel(firstLevel);
                        }
                        
                        // Save to localStorage
                        saveLevelsToStorage();
                        
                        showMessage(`Imported ${numLevels} levels successfully`, "success");
                        isDirty = false;
                    }
                } catch (error) {
                    showMessage(`Import Error: ${error.message}`, "error");
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        // Show message
        function showMessage(text, type = "info") {
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
        
        // Initialize on page load
        window.addEventListener('load', initEditor);
        
        // Ask for confirmation before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (isDirty) {
                const message = 'You have unsaved changes. Are you sure you want to leave?';
                e.returnValue = message;
                return message;
            }
        });
    </script>
</body>
</html>